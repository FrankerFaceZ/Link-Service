<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/FrankerFaceZ/link-service" >GitHub</a></h2><h3>Classes</h3><ul><li><a href="CacheInterface.html">CacheInterface</a><ul class='methods'><li data-type='method'><a href="CacheInterface.html#get">get</a></li><li data-type='method'><a href="CacheInterface.html#set">set</a></li></ul></li><li><a href="DocumentBuilder.html">DocumentBuilder</a><ul class='methods'><li data-type='method'><a href="DocumentBuilder.html#add">add</a></li><li data-type='method'><a href="DocumentBuilder.html#addConditional">addConditional</a></li><li data-type='method'><a href="DocumentBuilder.html#addField">addField</a></li><li data-type='method'><a href="DocumentBuilder.html#addFields">addFields</a></li><li data-type='method'><a href="DocumentBuilder.html#addHeader">addHeader</a></li><li data-type='method'><a href="DocumentBuilder.html#build">build</a></li><li data-type='method'><a href="DocumentBuilder.html#content">content</a></li><li data-type='method'><a href="DocumentBuilder.html#done">done</a></li><li data-type='method'><a href="DocumentBuilder.html#end">end</a></li><li data-type='method'><a href="DocumentBuilder.html#setCompactHeader">setCompactHeader</a></li><li data-type='method'><a href="DocumentBuilder.html#setExtra">setExtra</a></li><li data-type='method'><a href="DocumentBuilder.html#setFooter">setFooter</a></li><li data-type='method'><a href="DocumentBuilder.html#setHeader">setHeader</a></li><li data-type='method'><a href="DocumentBuilder.html#setLogo">setLogo</a></li><li data-type='method'><a href="DocumentBuilder.html#setSubtitle">setSubtitle</a></li><li data-type='method'><a href="DocumentBuilder.html#setTitle">setTitle</a></li></ul></li><li><a href="LinkService.html">LinkService</a><ul class='methods'><li data-type='method'><a href="LinkService.html#getExamples">getExamples</a></li><li data-type='method'><a href="LinkService.html#normalizeURL">normalizeURL</a></li><li data-type='method'><a href="LinkService.html#pickResolver">pickResolver</a></li><li data-type='method'><a href="LinkService.html#proxyImage">proxyImage</a></li><li data-type='method'><a href="LinkService.html#registerDefaultResolvers">registerDefaultResolvers</a></li><li data-type='method'><a href="LinkService.html#registerResolver">registerResolver</a></li><li data-type='method'><a href="LinkService.html#resolve">resolve</a></li></ul></li><li><a href="Redirect.html">Redirect</a></li><li><a href="Resolver.html">Resolver</a><ul class='methods'><li data-type='method'><a href="Resolver.html#builder">builder</a></li><li data-type='method'><a href="Resolver.html#getExamples">getExamples</a></li><li data-type='method'><a href="Resolver.html#handles">handles</a></li><li data-type='method'><a href="Resolver.html#processBody">processBody</a></li><li data-type='method'><a href="Resolver.html#processHeaders">processHeaders</a></li><li data-type='method'><a href="Resolver.html#proxyImage">proxyImage</a></li><li data-type='method'><a href="Resolver.html#transformURL">transformURL</a></li></ul></li><li><a href="UseMetadata.html">UseMetadata</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-responses.html">responses</a></li></ul><h3>Global</h3><ul><li><a href="global.html#BackgroundAwareImage">BackgroundAwareImage</a></li><li><a href="global.html#boxToken">boxToken</a></li><li><a href="global.html#CacheOptions">CacheOptions</a></li><li><a href="global.html#CacheResult">CacheResult</a></li><li><a href="global.html#conditionalToken">conditionalToken</a></li><li><a href="global.html#ExampleURL">ExampleURL</a></li><li><a href="global.html#fetch">fetch</a></li><li><a href="global.html#Field">Field</a></li><li><a href="global.html#flexToken">flexToken</a></li><li><a href="global.html#formatSize">formatSize</a></li><li><a href="global.html#formatToken">formatToken</a></li><li><a href="global.html#galleryToken">galleryToken</a></li><li><a href="global.html#i18nToken">i18nToken</a></li><li><a href="global.html#iconToken">iconToken</a></li><li><a href="global.html#imageToken">imageToken</a></li><li><a href="global.html#linkToken">linkToken</a></li><li><a href="global.html#normalizeURL">normalizeURL</a></li><li><a href="global.html#overlayToken">overlayToken</a></li><li><a href="global.html#RequestContext">RequestContext</a></li><li><a href="global.html#RichToken">RichToken</a></li><li><a href="global.html#styleToken">styleToken</a></li><li><a href="global.html#truncate">truncate</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

import {tldExists} from 'tldjs';
import {URL} from 'url';
import crypto from 'crypto';
import requireAll from 'require-all';
import LRUCache from 'mnemonist/lru-cache';

import fetch from './fetch-timeout';
import normalizeURL from './normalize-url';
import {InvalidHostError, UnsupportedPortError, UnsupportedSchemeError} from './errors/url';
import {UseMetadata, Redirect} from './results';
import {RuntimeError, RedirectLoopError, TooManyRedirectsError} from './errors/runtime';
import Resolver from './resolver';

import Metadata from './metadata';
import BaseError from './errors/base';
import {i18nToken} from './builder';

const PACKAGE = require('../package.json');

function b64tourl(data) {
	return data.replace(/\+/g, '-').replace(/\//g, '_');
}


/**
 * The LinkService class manages {@link Resolver} instances, stores
 * configuration, and performs the main look-up look for links including
 * SafeBrowsing hits if configured.
 *
 * @param {Object} [opts] Options for initializing the serice.
 * @param {CacheInterface} [opts.cache] A cache interface for use in caching intermediate and final responses.
 * @param {Number} [opts.max_redirects=20] The maximum number of redirects to follow.
 * @param {Number} [opts.domain_cache_size=300] The maximum number of domains to cache in the LRU cache.
 * @param {String} [opts.safe_browsing_server] The URL of a Google SafeBrowsing API server to use for looking up SafeBrowsing data.
 * @param {String} [opts.user_agent] The `User-Agent` to send with all HTTP requests.
 * @param {String|URL} [opts.default_referrer] The default Referer to use when making HTTP requests.
 * @param {Number} [opts.resolver_timeout=4000] The number of miliseconds to wait for a remote server before timing out.
 * @param {Object} [opts.image_proxy] Options for an imageproxy server.
 * @param {String} [opts.image_proxy.host] The URL of an imageproxy server for use when proxying images.
 * @param {String} [opts.image_proxy.key] The base-64 signing key to use for authenticating proxied image URLs.
 */
class LinkService {
	constructor(opts = {}) {
		this.opts = Object.assign({}, LinkService.DEFAULT_OPTS, opts);

		this.domain_cache = new LRUCache(this.opts.domain_cache_size);
		this.resolvers = [];

		if ( this.opts.cache )
			this.cache = this.opts.cache;

		this.metadata_resolver = new Metadata(this);
	}

	/**
	 * Register all of the default resolvers that come packaged with
	 * the LinkService. A list of those resolvers can be found at
	 * {@link https://github.com/FrankerFaceZ/link-service/tree/master/lib/resolvers}
	 */
	registerDefaultResolvers() {
		requireAll({
			dirname: `${__dirname  }/resolvers`,
			resolve: module => {
				if ( module?.default )
					this.registerResolver(module.default);
			}
		});
	}

	/**
	 * Register a new {@link Resolver} with the LinkService. If a
	 * class is passed, an instance will be greated automatically.
	 *
	 * > *Note:* Registering a resolver has the side effect of
	 * > clearing the domain cache.
	 *
	 * @param {Resolver} resolver The resolver to register.
	 * @returns {Resolver} The registered resolver.
	 */
	registerResolver(resolver) {
		if ( resolver &amp;&amp; resolver.prototype instanceof Resolver )
			resolver = new resolver(this);

		this.resolvers.push(resolver);
		this.resolvers.sort((a, b) => a.priority - b.priority);
		this.domain_cache.clear();

		return resolver;
	}

	/**
	 * Gather an array of example URLs from all the registered
	 * resolvers, for use in populating a selection field in
	 * a testing client.
	 * @returns {ExampleURL[]} List of URLs.
	 */
	getExamples() {
		const out = [];
		for (const resolver of [...this.resolvers, this.metadata_resolver]) {
			if ( ! resolver )
				continue;

			const name = resolver.constructor.name,
				examples = resolver.getExamples();
			if ( Array.isArray(examples) )
				for (let example of examples) {
					if ( example instanceof URL || typeof example === 'string' )
						example = {
							url: example
						};
					else if ( typeof example !== 'object' )
						throw new TypeError(`Invalid result from getExamples from resolver: ${name}`, example);

					if ( example.url instanceof URL )
						example.url = example.url.toString();
					else if ( typeof example.url !== 'string' )
						throw new TypeError(`Invalid result from getExamples from resolver: ${name}`, example);

					if ( ! example.resolver )
						example.resolver = resolver.constructor.name;

					out.push(example);
				}
		}

		return out;
	}


	/**
	 * Create a URL for passing an image through a proxy, used to
	 * avoid leaking end-user IP addresses and to perform sanity
	 * checks on the contents of the image.
	 *
	 * Currently, this method is written to generate URLs for the
	 * {@link https://github.com/willnorris/imageproxy} project, as
	 * that's what FrankerFaceZ is using.
	 *
	 * This returns `null` if no `image_proxy_host` is set in
	 * options as end-user security should be the default. If you
	 * really, really want to pass URLs through unmodified this
	 * must be set to {@link LinkService.ALLOW_UNSAFE_IMAGES}.
	 *
	 * @param {String|URL} url The URL to proxy.
	 * @param {Number} [size=324] The size parameter to pass to the proxy server.
	 * @returns {String} The proxied image URL, or `null` if no proxy server is configured.
	 */
	proxyImage(url, size = 324) {
		const host = this.opts.image_proxy?.host;
		if ( host === LinkService.ALLOW_UNSAFE_IMAGES )
			return url;
		else if ( ! host )
			return null;

		if ( typeof size !== 'string' )
			size += ',fit';

		url = url.toString();

		let signature = '';
		if ( this.opts.image_proxy.key )
			signature = `,s${b64tourl(crypto.createHmac('SHA256', this.opts.image_proxy.key).update(url).digest('base64'))}`;

		return `${host}/${size}${signature}/${url}`;
	}

	/**
	 * Normalize a URL. This method is used by the LinkService to
	 * normalize all URLs that it encounters. Normalization helps
	 * ensure better cache hit rates and lets the service work with
	 * a degree of garbage input.
	 *
	 * This method can be overwritten for custom behavior, and
	 * by default it just calls the {@link normalizeURL} method
	 * from utilities.
	 *
	 * @param {String|URL} url The URL to normalize
	 * @param {URL} base A base URL to use to build an absolute URL, if the input URL is relative.
	 * @returns {URL} A normalized URL
	 */
	normalizeURL(url, base) {
		return normalizeURL(url, base, this.opts.default_scheme);
	}

	/**
	 * Pick the best resolver to handle a given URL from the list of
	 * known {@link Resolver} instances. This also caches the
	 * decision in a LRU cache to speed up subsequent URLs from
	 * the same domain.
	 * @param {String|URL} url The URL to pick a resolver for. If this is a String, it will be run through {@link LinkService#normalizeURL} first.
	 * @returns {Resolver} The resolver instance to use for processing.
	 */
	pickResolver(url) {
		if ( ! (url instanceof URL) )
			url = this.normalizeURL(url);

		const host = url.host;

		let resolver = this.domain_cache.get(host);
		if ( resolver !== undefined )
			return resolver;

		for (const r of this.resolvers) {
			if ( r.handles(host) ) {
				resolver = r;
				break;
			}
		}

		if ( ! resolver ) {
			if ( tldExists(url.hostname) )
				resolver = this.metadata_resolver;
			else
				resolver = null;
		}

		this.domain_cache.set(host, resolver);
		return resolver;
	}

	/**
	 * Normalize a URL and use {@link Resolver} instances to retrieve metadata
	 * for the URL, keeping track of redirects and looking up SafeBrowsing
	 * records on all URLs. Essentially: the heart of the service.
	 *
	 * Returns a response, as in: {@tutorial responses}
	 *
	 * @param {String|URL} url The URL to resolve.
	 * @returns {Object} The metadata to be sent to clients.
	 */
	async resolve(url) {
		try {
			url = this.normalizeURL(url);
		} catch (err) {
			if ( err instanceof BaseError ) {
				return {
					error: err.getMessage() ?? err.toString()
				}
			} else
				throw err;
		}

		const visited_urls = [];
		let redirects = 0,
			referrer = null,
			result = null,
			force_metadata = false;

		// Main Resolve Loop
		visited_urls.push(url);

		while (url &amp;&amp; redirects &lt; this.opts.max_redirects) {
			if ( ! (url instanceof URL) )
				url = this.normalizeURL(url);

			// Do not handle URLs with non-standard ports.
			// Do not handle URLs without http: or https:
			if ( url.protocol !== 'https:' &amp;&amp; url.protocol !== 'http:' ) {
				result = new UnsupportedSchemeError(url);
				break;
			}

			if ( url.port ) {
				const is_https = url.protocol === 'https:',
					expected = is_https ? 443 : 80;

				// eslint-disable-next-line eqeqeq
				if ( url.port != expected ) {
					result = new UnsupportedPortError(url);
					break;
				}
			}

			let resolver;
			try {
				resolver = force_metadata ? this.metadata_resolver : this.pickResolver(url);
			} catch (err) {
				if ( err instanceof BaseError ) {
					result = err;
					break;
				} else
					throw err;
			}

			if ( ! resolver ) {
				result = new InvalidHostError(url);
				break;
			}

			try {
				result = await resolver._run(url, referrer);
			} catch (err) {
				if ( err instanceof BaseError ) {
					result = err;
					break;
				} else
					throw err;
			}

			if ( result === UseMetadata || result instanceof UseMetadata ) {
				if ( resolver === this.metadata_resolver )
					throw new RuntimeError('Unexpected response from Metadata Resolver');

				force_metadata = true;

			} else if ( result instanceof Redirect ) {
				referrer = url;
				url = this.normalizeURL(result.url, result.base || referrer);
				if ( visited_urls.includes(url) ) {
					result = new RedirectLoopError();
					break;
				}

				visited_urls.push(url);
				force_metadata = false;

				redirects++;

			} else
				url = null;
		}


		// Were we still redirecting?
		if ( result instanceof Redirect )
			result = new TooManyRedirectsError();

		// Did we get an error?
		if ( result instanceof BaseError ) {
			result = {
				error: result.getMessage() ?? result.toString()
			}
		}

		if ( ! result )
			result = {
				error: i18nToken('card.error.empty', 'No Information Available')
			};

		// Safe Browsing
		let unsafe = false;
		const urls = {};
		for (const url of visited_urls) {
			const u = url.toString();
			urls[u] = {url: u, unsafe: false, flags: []};
		}

		if ( this.opts.safe_browsing_server ) {
			const data = await fetch(`${this.opts.safe_browsing_server}/v4/threatMatches:find`, {
				method: 'POST',
				body: JSON.stringify({
					threatInfo: {
						threatTypes: ['UNWANTED_SOFTWARE', 'MALWARE', 'SOCIAL_ENGINEERING'],
						platformTypes: ['ANY_PLATFORM'],
						threatEntryTypes: ['URL'],
						threatEntries: visited_urls.map(url => ({url: url.toString()}))
					}
				}),
				headers: {
					'Content-Type': 'application/json'
				},
				timeout: 1000
			}).then(resp => resp.ok ? resp.json() : null).catch(() => null);

			if ( data &amp;&amp; Array.isArray(data.matches) &amp;&amp; data.matches.length ) {
				for (const match of data.matches) {
					const url = match?.threat?.url,
						url_data = urls[url];

					if ( ! url_data )
						continue;

					url_data.unsafe = true;
					if ( ! url_data.flags.includes(match.threatType) )
						url_data.flags.push(match.threatType);
					unsafe = true;
				}
			}
		}

		result.unsafe = unsafe;
		result.urls = Object.values(urls);

		return result;
	}
}

LinkService.ALLOW_UNSAFE_IMAGES = Symbol('ALLOW_UNSAFE_IMAGES');

// If you add stuff here, remember to add them to the jsdoc on the class as
// well so they end up in the documentation.

LinkService.DEFAULT_OPTS = {
	// The maximum number of redirects to follow.
	max_redirects: 20,

	// Number of domains to cache in the resolver look-up table.
	domain_cache_size: 300,

	// The URL of a Safe Browsing cache server. Safe Browsing only runs when this is set.
	safe_browsing_server: null,

	// The user agent to use when making requests.
	user_agent: `Mozilla/5.0 (compatible; FFZBot/${PACKAGE.version}; +https://www.frankerfacez.com)`,

	// The default referrer to use when making requests.
	default_referrer: null,

	// The number of ms to wait for a remote server before timing out.
	resolver_timeout: 4000,

	// Image Stuff
	// The built-in implementation is made for use with
	// https://github.com/willnorris/imageproxy but the function can be
	// replaced fairly easily.
	image_proxy: {
		host: null,
		key: null
	}
}


export default LinkService;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Fri Sep 03 2021 13:44:26 GMT-0400 (Eastern Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
